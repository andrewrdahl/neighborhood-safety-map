<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neighborhood Safety Map</title>

  <!-- Leaflet CSS (no SRI) -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Your own styling -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="map"></div>

<!-- ---------------------------------------------------------
     1ï¸âƒ£ Load Leaflet core (must come BEFORE any code that uses L)
     ---------------------------------------------------------- -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Plugins (also must load before our custom code) -->
<script src="https://unpkg.com/leaflet-gpx@1.5.0/gpx.min.js"></script>
<script src="https://unpkg.com/leaflet-ajax@2.2.1/dist/leaflet.ajax.min.js"></script>

<!-- ---------------------------------------------------------
     2ï¸âƒ£ Our custom map script â€“ wrapped in DOMContentLoaded
     ---------------------------------------------------------- -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* -------------------------------------------------------
     2.1 Initialise the map â€“ fit it to the four corner points
     ------------------------------------------------------- */
  const map = L.map('map');   // create map container, no centre/zoom yet

  // ---- Four coordinates you supplied (lat, lon) ----
  const cornerPoints = [
    L.latLng(44.915980401831014, -93.29213180874551),
    L.latLng(44.93910303039243 , -93.29007482943638),
    L.latLng(44.93838777366788 , -93.27170636411634),
    L.latLng(44.91610817665654 , -93.2716702766504)
  ];

  // Build a bounds object that encloses all four points
  const bounds = L.latLngBounds(cornerPoints);

  // Fit the map to those bounds (30â€¯px padding keeps points away from the edge)
  map.fitBounds(bounds, { padding: [30, 30] });

  /* -------------------------------------------------------
     2.2 Add the OpenStreetMap basemap (must keep attribution)
     ------------------------------------------------------- */
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
  }).addTo(map);

  /* -------------------------------------------------------
     2.3 Load GPX routes (if you have any)
     ------------------------------------------------------- */
  fetch('data/routes-index.json')
    .then(r => r.json())
    .then(list => {
      list.forEach(fname => {
        new L.GPX(`data/${fname}`, {
          async: true,
          marker_options: {
            startIconUrl:
              'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl:
              'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
          }
        }).addTo(map);
      });
    })
    .catch(err => console.warn('No GPX routes loaded', err));

  /* -------------------------------------------------------
     2.4 Load point data (trashâ€‘cans, hazards, etc.)
     ------------------------------------------------------- */
  const pointLayer = new L.GeoJSON.AJAX('data/points.geojson', {
    pointToLayer: (feature, latlng) => {
      const icon = L.divIcon({
        html: 'ðŸ—‘ï¸',
        className: '',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
      return L.marker(latlng, { icon });
    },
    onEachFeature: (feature, layer) => {
      const p = feature.properties || {};
      let popup = `<strong>${p.name || 'Location'}</strong><br>${p.description || ''}`;
      if (p.photo) {
        popup += `<br><img src="${p.photo}" style="max-width:200px;">`;
      }
      layer.bindPopup(popup);
    }
  }).addTo(map);

}); // end DOMContentLoaded listener
</script>
</body>
</html>
